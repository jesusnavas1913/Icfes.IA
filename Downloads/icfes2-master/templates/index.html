<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simulador ICFES Pro</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <div class="container">
    <h1>ğŸ“ Simulador ICFES Pro</h1>
    <p class="subtitle">Practica con preguntas generadas por IA</p>

    <div class="config-panel">
      <div class="input-group">
        <label for="tema">ğŸ“š Tema de las preguntas:</label>
        <input type="text" id="tema" placeholder="Ej: biologÃ­a, matemÃ¡ticas, lectura crÃ­tica..." value="razonamiento lÃ³gico">
      </div>

      <div class="input-group">
        <label for="cantidad">ğŸ”¢ NÃºmero de preguntas:</label>
        <select id="cantidad">
          <option value="1">1 pregunta</option>
          <option value="3">3 preguntas</option>
          <option value="5" selected>5 preguntas</option>
          <option value="7">7 preguntas</option>
          <option value="10">10 preguntas</option>
        </select>
      </div>

      <div class="input-group">
        <label for="dificultad">âš¡ Nivel de dificultad:</label>
        <select id="dificultad">
          <option value="facil">FÃ¡cil</option>
          <option value="medio" selected>Medio</option>
          <option value="dificil">DifÃ­cil</option>
        </select>
      </div>

      <div class="button-group">
        <button id="btnGenerar">ğŸš€ Generar Simulacro</button>
        <button id="btnReset" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">ğŸ”„ Reiniciar</button>
      </div>
    </div>

    <div id="progreso" style="display: none;"></div>
    <div id="resultado"></div>
  </div>

  <script>
    let preguntas = [];
    let preguntaActual = 0;
    let respuestas = [];
    let correctas = 0;

    const btnGenerar = document.getElementById('btnGenerar');
    const btnReset = document.getElementById('btnReset');
    const resultado = document.getElementById('resultado');
    const progreso = document.getElementById('progreso');

    btnGenerar.addEventListener('click', generarSimulacro);
    btnReset.addEventListener('click', reiniciar);

    async function generarSimulacro() {
      const tema = document.getElementById('tema').value.trim() || 'razonamiento lÃ³gico';
      const cantidad = parseInt(document.getElementById('cantidad').value);
      const dificultad = document.getElementById('dificultad').value;

      btnGenerar.disabled = true;
      resultado.innerHTML = '<div class="loading">â³ Generando preguntas con IA...</div>';
      progreso.style.display = 'none';

      try {
        const res = await fetch('/api/preguntas-multiples', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tema, cantidad, dificultad })
        });

        const data = await res.json();

        if (data.error) {
          resultado.innerHTML = `<div class="feedback incorrecto">âš ï¸ Error: ${data.error}</div>`;
          btnGenerar.disabled = false;
          return;
        }

        preguntas = data.preguntas;
        preguntaActual = 0;
        respuestas = [];
        correctas = 0;

        mostrarPregunta();
        btnGenerar.disabled = false;

      } catch (error) {
        resultado.innerHTML = `<div class="feedback incorrecto">âŒ Error de conexiÃ³n: ${error.message}</div>`;
        btnGenerar.disabled = false;
      }
    }

    function mostrarPregunta() {
      if (preguntaActual >= preguntas.length) {
        mostrarResultados();
        return;
      }

      const pregunta = preguntas[preguntaActual];
      progreso.style.display = 'block';
      
      progreso.innerHTML = `
        <div class="progreso">
          <strong>Pregunta ${preguntaActual + 1} de ${preguntas.length}</strong>
          <div class="progreso-bar">
            <div class="progreso-fill" style="width: ${((preguntaActual + 1) / preguntas.length) * 100}%"></div>
          </div>
          <small>${correctas} correctas de ${preguntaActual} respondidas</small>
        </div>
      `;

      let html = `
        <div class="pregunta-card">
          <div class="pregunta-numero">Pregunta ${pregunta.numero}</div>
          <div class="pregunta-texto">${pregunta.pregunta}</div>
          <div class="opciones">
      `;

      pregunta.opciones.forEach((opcion, index) => {
        const letra = String.fromCharCode(65 + index);
        html += `<button class="opcion-btn" data-letra="${letra}">${opcion}</button>`;
      });

      html += `</div></div>`;
      resultado.innerHTML = html;

      document.querySelectorAll('.opcion-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const seleccionada = e.target.getAttribute('data-letra');
          verificarRespuesta(seleccionada);
        });
      });
    }

    function verificarRespuesta(seleccionada) {
      const pregunta = preguntas[preguntaActual];
      const correcta = pregunta.respuesta_correcta;
      const esCorrecta = seleccionada === correcta;

      if (esCorrecta) correctas++;

      respuestas.push({
        pregunta: pregunta.pregunta,
        seleccionada: seleccionada,
        correcta: correcta,
        esCorrecta: esCorrecta
      });

      let html = `
        <div class="pregunta-card">
          <div class="pregunta-numero">Pregunta ${pregunta.numero}</div>
          <div class="pregunta-texto">${pregunta.pregunta}</div>
          <div class="opciones">
      `;

      pregunta.opciones.forEach((opcion, index) => {
        const letra = String.fromCharCode(65 + index);
        let clase = '';
        if (letra === correcta) clase = 'correcta';
        else if (letra === seleccionada) clase = 'incorrecta';
        html += `<button class="opcion-btn ${clase}" disabled>${opcion}</button>`;
      });

      html += '</div>';

      if (esCorrecta) {
        html += `<div class="feedback correcto">âœ… Â¡Correcto! Has seleccionado la respuesta ${correcta}.</div>`;
      } else {
        html += `
          <div class="feedback incorrecto">
            âŒ Incorrecto. Seleccionaste ${seleccionada}, pero la respuesta correcta es ${correcta}.
          </div>
          <div class="explicacion">
            <strong>ğŸ’¡ ExplicaciÃ³n:</strong> ${pregunta.explicacion}
          </div>
        `;
      }

      html += `<button onclick="siguientePregunta()" style="margin-top: 20px; width: 100%;">â¡ï¸ Siguiente Pregunta</button>`;
      html += '</div>';

      resultado.innerHTML = html;
    }

    function siguientePregunta() {
      preguntaActual++;
      mostrarPregunta();
    }

    function mostrarResultados() {
      const porcentaje = Math.round((correctas / preguntas.length) * 100);
      let mensaje = '';
      let emoji = '';

      if (porcentaje >= 90) {
        mensaje = 'Â¡Excelente! Dominas el tema';
        emoji = 'ğŸ†';
      } else if (porcentaje >= 70) {
        mensaje = 'Â¡Muy bien! Buen desempeÃ±o';
        emoji = 'ğŸ‰';
      } else if (porcentaje >= 50) {
        mensaje = 'Bien, pero puedes mejorar';
        emoji = 'ğŸ“š';
      } else {
        mensaje = 'Necesitas practicar mÃ¡s';
        emoji = 'ğŸ’ª';
      }

      resultado.innerHTML = `
        <div class="resultado-final">
          <div style="font-size: 5em; margin-bottom: 20px;">${emoji}</div>
          <h2>${mensaje}</h2>
          <div class="estadisticas">
            <div class="stat-item">
              <div class="stat-numero">${correctas}</div>
              <div class="stat-label">Correctas</div>
            </div>
            <div class="stat-item">
              <div class="stat-numero">${preguntas.length - correctas}</div>
              <div class="stat-label">Incorrectas</div>
            </div>
            <div class="stat-item">
              <div class="stat-numero">${porcentaje}%</div>
              <div class="stat-label">Porcentaje</div>
            </div>
          </div>
          <button onclick="reiniciar()" style="margin-top: 30px; background: white; color: #667eea; width: 100%;">
            ğŸ”„ Hacer Otro Simulacro
          </button>
        </div>
      `;

      progreso.style.display = 'none';
    }

    function reiniciar() {
      preguntas = [];
      preguntaActual = 0;
      respuestas = [];
      correctas = 0;
      resultado.innerHTML = '';
      progreso.style.display = 'none';
      document.getElementById('tema').value = 'razonamiento lÃ³gico';
      document.getElementById('cantidad').value = '5';
      document.getElementById('dificultad').value = 'medio';
    }
  </script>
</body>
</html>